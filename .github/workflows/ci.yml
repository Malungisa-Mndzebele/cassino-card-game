name: Casino Card Game CI/CD

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: casino_game
          POSTGRES_USER: casino_user
          POSTGRES_PASSWORD: casino_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Python dependencies
      run: |
        cd backend
        pip install -r requirements.txt
    
    - name: Run backend tests
      run: |
        cd backend
        python run_simple_tests.py
      env:
        DATABASE_URL: postgresql://casino_user:casino_password@localhost:5432/casino_game
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install Node.js dependencies
      run: npm ci
    
    - name: Verify frontend files
      run: |
        ls -la index.html
        ls -la App.js
        ls -la dev-server.js

  build:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install Node.js dependencies
      run: npm ci
    
    - name: Run build step
      run: npm run build
    
    - name: Verify build output
      run: |
        echo "✅ Build completed successfully"
        echo "📁 Project files ready for deployment"

  deploy:
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/master'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Prepare deployment files
      run: |
        echo "📦 Preparing files for deployment..."
        
        # Create deployment directory
        mkdir -p dist
        
        # Copy frontend files
        cp index.html dist/
        cp App.js dist/ || echo "No App.js (using vanilla JS)"
        cp manifest.json dist/ || echo "No manifest.json"
        cp favicon.svg dist/ || echo "No favicon.svg"
        cp -r public dist/ || echo "No public directory"
        cp -r frontend dist/ || echo "No frontend directory"
        cp package.json dist/
        cp package-lock.json dist/ || echo "No package-lock.json"
        
        # Copy backend files
        mkdir -p dist/backend
        cp -r backend/* dist/backend/
        
        # Create PHP wrapper for Python backend
        cat > dist/backend/start.php << 'EOF'
        <?php
        // Set headers for JSON response
        header('Content-Type: application/json');
        
        // Get the request path
        $request_uri = $_SERVER['REQUEST_URI'];
        $path = parse_url($request_uri, PHP_URL_PATH);
        
        // Remove /backend from the start if present
        $path = preg_replace('/^\/backend/', '', $path);
        
        // Forward the request to Python backend
        $python_url = "http://localhost:8000" . $path;
        $method = $_SERVER['REQUEST_METHOD'];
        
        // Get request body for POST/PUT requests
        $body = file_get_contents('php://input');
        
        // Set up cURL request
        $ch = curl_init($python_url);
        curl_setopt($ch, CURLOPT_CUSTOMREQUEST, $method);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        
        if ($method === 'POST' || $method === 'PUT') {
            curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
            curl_setopt($ch, CURLOPT_HTTPHEADER, array(
                'Content-Type: application/json',
                'Content-Length: ' . strlen($body)
            ));
        }
        
        // Execute request
        $response = curl_exec($ch);
        $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        curl_close($ch);
        
        // Set response code
        http_response_code($http_code);
        
        // Output response
        echo $response;
        EOF
        
        # Create .htaccess for frontend routing
        cat > dist/.htaccess << 'EOF'
        RewriteEngine On
        
        # Handle backend requests
        RewriteRule ^api/(.*)$ backend/start.php [QSA,L]
        
        # Handle frontend routes
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^ index.html [QSA,L]
        EOF
        
        echo "✅ Deployment files prepared"
    
    - name: Deploy to Spaceship via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: server28.shared.spaceship.host
        username: cassino@khasinogaming.com
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./dist/
        server-dir: /
    
    - name: Deployment Status
      run: |
        echo "🎉 Casino Card Game deployed successfully!"
        echo "✅ All tests passed"
        echo "✅ Build completed successfully"
        echo "✅ Deployed to khasinogaming.com"
        echo "🌐 Live at: https://khasinogaming.com/cassino/"
        echo "🎮 Ready for multiplayer gaming!"
