"""
Comprehensive tests for game_logic.py to achieve high coverage
"""
import pytest
from game_logic import CasinoGameLogic, GamePhase
from models import GameState, Player, Card


class TestCasinoGameLogic:
    """Test suite for CasinoGameLogic class"""
    
    @pytest.fixture
    def game_logic(self):
        """Create a game logic instance"""
        return CasinoGameLogic()
    
    @pytest.fixture
    def sample_game_state(self):
        """Create a sample game state"""
        return GameState(
            room_id="TEST01",
            phase=GamePhase.WAITING,
            player1_id="player1",
            player2_id="player2",
            player1_hand=[],
            player2_hand=[],
            table_cards=[],
            deck=[],
            player1_captured=[],
            player2_captured=[],
            player1_score=0,
            player2_score=0,
            current_turn="player1",
            last_capture_player=None,
            round_number=1
        )
    
    # Initialization Tests
    def test_init_creates_deck(self, game_logic):
        """Test that initialization creates a full deck"""
        assert len(game_logic.deck) == 52
        
    def test_init_deck_has_all_suits(self, game_logic):
        """Test that deck contains all four suits"""
        suits = set(card['suit'] for card in game_logic.deck)
        assert suits == {'hearts', 'diamonds', 'clubs', 'spades'}
    
    def test_init_deck_has_all_ranks(self, game_logic):
        """Test that deck contains all ranks"""
        ranks = set(card['rank'] for card in game_logic.deck)
        expected_ranks = {'A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'}
        assert ranks == expected_ranks
    
    # Shuffle Tests
    def test_shuffle_maintains_deck_size(self, game_logic):
        """Test that shuffling maintains deck size"""
        original_size = len(game_logic.deck)
        game_logic.shuffle()
        assert len(game_logic.deck) == original_size
    
    def test_shuffle_changes_order(self, game_logic):
        """Test that shuffling changes card order"""
        original_deck = game_logic.deck.copy()
        game_logic.shuffle()
        # Very unlikely to be the same after shuffle
        assert game_logic.deck != original_deck
    
    # Deal Tests
    def test_deal_initial_cards(self, game_logic, sample_game_state):
        """Test dealing initial cards"""
        game_logic.deck = [
            {'suit': 'hearts', 'rank': 'A', 'value': 1},
            {'suit': 'hearts', 'rank': '2', 'value': 2},
            {'suit': 'hearts', 'rank': '3', 'value': 3},
            {'suit': 'hearts', 'rank': '4', 'value': 4},
            {'suit': 'hearts', 'rank': '5', 'value': 5},
            {'suit': 'hearts', 'rank': '6', 'value': 6},
            {'suit': 'hearts', 'rank': '7', 'value': 7},
            {'suit': 'hearts', 'rank': '8', 'value': 8},
            {'suit': 'hearts', 'rank': '9', 'value': 9},
            {'suit': 'hearts', 'rank': '10', 'value': 10},
            {'suit': 'hearts', 'rank': 'J', 'value': 11},
            {'suit': 'hearts', 'rank': 'Q', 'value': 12},
        ]
        
        # We need at least 12 cards for initial deal
        # The logic expects GameCard objects, but the test setup seems to be using dicts in the mock deck?
        # Wait, the logic.create_deck() returns GameCard objects.
        # But here we are manually setting game_logic.deck.
        # Let's check if game_logic.deck is expected to be GameCard objects.
        # Yes, game_logic.py uses GameCard objects.
        # So we should probably use GameCard objects here or rely on the fact that python is dynamic.
        # However, accessing attributes like .suit and .rank later will fail if they are dicts.
        # Let's fix the test to use GameCard objects.
        
        from game_logic import GameCard
        game_logic.deck = [
            GameCard(id=f"{i}_hearts", suit='hearts', rank=str(i), value=i) 
            for i in range(1, 15)
        ]
        
        table, p1, p2, remaining = game_logic.deal_initial_cards(game_logic.deck)
        
        assert len(table) == 4
        assert len(p1) == 4
        assert len(p2) == 4
        assert len(remaining) == len(game_logic.deck) - 12 